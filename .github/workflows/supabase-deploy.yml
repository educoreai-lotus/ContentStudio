name: Supabase Database Migration

on:
  push:
    branches: [ main ]
    paths:
      - 'database/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # âœ… Use the official Supabase CLI installer
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI installed
        run: |
          supabase --version
          which supabase

      - name: Link to Supabase Project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Verify Supabase Connection
        run: supabase db list
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Parse database connection info
        id: parse-db
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python <<'PY'
          import os, urllib.parse
          url = os.environ['DATABASE_URL']
          parsed = urllib.parse.urlparse(url)
          password = urllib.parse.unquote(parsed.password or '')
          print(f"::add-mask::{password}")
          outputs = {
              'host': parsed.hostname or '',
              'port': parsed.port or 5432,
              'user': parsed.username or '',
              'dbname': (parsed.path or '').lstrip('/') or 'postgres',
              'password': password,
          }
          with open(os.environ['GITHUB_OUTPUT'], 'w') as f:
              for key, value in outputs.items():
                  f.write(f"{key}={value}\n")
          PY

      # âœ… Run all SQL files under database/migrations/
      - name: Run Custom Migrations from /database/migrations
        run: |
          set -e
          export PGSSLMODE=require
          echo "ðŸš€ Running custom migrations from database/migrations..."
          for file in database/migrations/*.sql; do
            echo "Executing $file..."
            psql -f "$file"
          done
          echo "âœ… All migrations executed successfully."
        env:
          PGHOST: ${{ steps.parse-db.outputs.host }}
          PGPORT: ${{ steps.parse-db.outputs.port }}
          PGUSER: ${{ steps.parse-db.outputs.user }}
          PGDATABASE: ${{ steps.parse-db.outputs.dbname }}
          PGPASSWORD: ${{ steps.parse-db.outputs.password }}

      - name: Migration Summary
        run: echo "âœ… Supabase custom migrations completed successfully!"

      - name: Notify on failure
        if: failure()
        run: echo "âŒ Database migration failed! Please check the logs."
